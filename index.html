<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grow A Garden Stock V2</title>
    <meta name="theme-color" content="#4CAF50" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #1a202c;
            min-height: 100vh;
            font-family: 'Inter', system-ui, sans-serif;
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            /* Prevent body scroll when sidebar is open on mobile */
            overflow-x: hidden;
        }
        body.sidebar-open {
            overflow: hidden; /* Prevent scrolling of main content when sidebar is open */
        }
        .sidebar {
            background: #2d3748;
            width: 250px;
            height: 100vh;
            position: fixed;
            padding: 1.5rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            z-index: 1000; /* Ensure sidebar is above main content */
            transform: translateX(-250px); /* Initially hidden on small screens */
        }
        .sidebar.open {
            transform: translateX(0); /* Show sidebar */
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .nav-item.active, .nav-item:hover {
            background-color: #4a5568;
        }
        .hamburger {
            display: none; /* Hidden by default, shown on mobile via media query */
            font-size: 1.5rem;
            cursor: pointer;
            color: #e2e8f0;
            padding: 1rem;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001; /* Ensure hamburger is above sidebar */
        }
        .main-content {
            margin-left: 0; /* Default on mobile */
            padding: 1.5rem;
            transition: margin-left 0.3s ease;
        }
        .main-content.shifted {
            margin-left: 250px; /* Shift content when sidebar is open on mobile */
        }
        .card, .item-card {
            background: #2d3748;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        .card:hover, .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        .card-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .status-bar {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #2d3748;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568;
            transition: 0.4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #48bb78;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .badge {
            background: #4a5568;
            padding: 0.25rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }
        .rarity {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: white;
        }
        .weather-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #4a5568;
            border-radius: 0.5rem;
            text-align: center;
        }

        /* Overlay for mobile when sidebar is open */
        body.sidebar-open::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black overlay */
            z-index: 999; /* Below sidebar, above main content */
            opacity: 0;
            pointer-events: none; /* Don't block clicks when not visible */
            transition: opacity 0.3s ease;
        }
        body.sidebar-open::after {
            opacity: 1;
            pointer-events: auto; /* Block clicks when visible */
        }

        /* Mobile Styles */
        @media (max-width: 767px) {
            .hamburger {
                display: block; /* Show hamburger on mobile */
            }
            .sidebar {
                /* On mobile, sidebar is initially off-screen */
                transform: translateX(-250px);
            }
            .sidebar.open {
                transform: translateX(0); /* Slide in when 'open' class is added */
            }
            .main-content {
                margin-left: 0; /* No margin on mobile by default */
            }
            .main-content.shifted {
                margin-left: 250px; /* Shift main content when sidebar is open */
            }
            .grid {
                grid-template-columns: 1fr; /* Stack cards on mobile */
            }
            /* Adjust status bar position for mobile */
            .status-bar {
                top: 0.5rem;
                right: 0.5rem;
                padding: 0.3rem 0.7rem;
                font-size: 0.8rem;
            }
            /* Adjust card margin on mobile to account for status bar */
            #summary-cards {
                margin-top: 5rem; /* Give more space below fixed status bar */
            }
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .hamburger {
                display: none; /* Hide hamburger on desktop */
            }
            .sidebar {
                transform: translateX(0); /* Always visible on desktop */
                position: fixed; /* Keep it fixed */
                height: 100vh;
                padding: 1.5rem;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
                transition: none; /* No sliding transition on desktop */
            }
            .main-content {
                margin-left: 250px; /* Always shifted on desktop */
                transition: none; /* No sliding transition on desktop */
            }
        }
    </style>
</head>
<body>
    <div class="hamburger">‚ò∞</div>
    <div class="sidebar" id="sidebar">
        <div class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="text-green-400">üå±</span> Grow A Garden
        </div>
        <nav>
            <div class="nav-item active" data-category="dashboard">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" data-category="seed_stock">
                <span>üåæ</span> Seeds
            </div>
            <div class="nav-item" data-category="gear_stock">
                <span>‚öôÔ∏è</span> Gear
            </div>
            <div class="nav-item" data-category="egg_stock">
                <span>ü•ö</span> Eggs
            </div>
            <div class="nav-item" data-category="cosmetic_stock">
                <span>üíÑ</span> Cosmetics
            </div>
            <div class="nav-item" data-category="eventshop_stock">
                <span>üéâ</span> Events
            </div>
        </nav>
        <div class="weather-info" id="weather-info">
            <p class="text-sm text-gray-300">Weather: Loading...</p>
            <p class="text-sm text-gray-300">Time Left: Loading...</p>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <div class="status-bar">
            <span class="text-green-400">‚óè Connected</span>
            <span>Updated: 05:17 PM</span>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-16" id="summary-cards">
            <div class="card relative">
                <div class="card-icon text-green-400">üå±</div>
                <h3 class="text-lg font-semibold">Available Seeds</h3>
                <p class="text-3xl font-bold mt-2" id="seed-count">4</p>
                <p class="text-sm text-gray-400 mt-1">Updated recently</p>
                <div class="badge text-green-400" id="seed-time">1m 0s</div>
            </div>
            <div class="card relative">
                <div class="card-icon text-yellow-500">‚öôÔ∏è</div>
                <h3 class="text-lg font-semibold">Gear Items</h3>
                <p class="text-3xl font-bold mt-2" id="gear-count">6</p>
                <p class="text-sm text-gray-400 mt-1">Updated recently</p>
                <div class="badge text-yellow-400" id="gear-time">1m 0s</div>
            </div>
            <div class="card relative">
                <div class="card-icon text-blue-400">ü•ö</div>
                <h3 class="text-lg font-semibold">Eggs</h3>
                <p class="text-3xl font-bold mt-2" id="egg-count">3</p>
                <p class="text-sm text-gray-400 mt-1">Updated recently</p>
                <div class="badge text-blue-400" id="egg-time">1m 0s</div>
            </div>
            <div class="card relative">
                <div class="card-icon text-purple-400">üíÑ</div>
                <h3 class="text-lg font-semibold">Cosmetics</h3>
                <p class="text-3xl font-bold mt-2" id="cosmetic-count">8</p>
                <p class="text-sm text-gray-400 mt-1">Updated recently</p>
                <div class="badge text-purple-400" id="cosmetic-time">1m 0s</div>
            </div>
            <div class="card relative">
                <div class="card-icon text-orange-500">üéâ</div>
                <h3 class="text-lg font-semibold">Events</h3>
                <p class="text-3xl font-bold mt-2" id="event-count">6</p>
                <p class="text-sm text-gray-400 mt-1">Updated recently</p>
                <div class="badge text-orange-400" id="event-time">1m 0s</div>
            </div>
        </div>

        <div class="mt-6 flex justify-center gap-4">
            <label class="flex items-center gap-2 text-lg font-medium text-gray-300">
                <span>In Stock</span>
                <div class="switch">
                    <input type="checkbox" id="view-toggle">
                    <span class="slider"></span>
                </div>
                <span>All Items</span>
            </label>
            <button id="refresh-btn" class="px-6 py-2 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors duration-200">üîÑ Refresh</button>
        </div>

        <div id="stock-container" class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>

    <div id="debug-tab" class="fixed bottom-6 right-6 bg-green-600 text-white p-3 rounded-full text-lg cursor-pointer hover:bg-green-700 transition-colors duration-200">ü™≤</div>
    <div id="debug-window" class="fixed bottom-20 right-6 w-80 max-h-96 bg-white/90 backdrop-filter blur-8px border border-gray-200 rounded-xl p-4 overflow-y-auto hidden">
        <button id="close-debug" class="bg-red-500 text-white px-3 py-1 rounded-lg float-right hover:bg-red-600 transition-colors duration-200">Close</button>
        <pre id="debug-content" class="text-xs text-gray-800 whitespace-pre-wrap break-all">Loading...</pre>
    </div>

    <script>
        const stockURL = 'https://api.joshlei.com/v2/growagarden/stock';
        const itemInfoURL = 'https://api.joshlei.com/v2/growagarden/info/';
        const weatherURL = 'https://api.joshlei.com/v2/growagarden/weather';
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        // FIX: Use querySelector to select by class as the HTML element has no ID
        const hamburger = document.querySelector('.hamburger');
        const summaryCards = document.getElementById('summary-cards');
        const stockContainer = document.getElementById('stock-container');
        const refreshBtn = document.getElementById('refresh-btn');
        const viewToggle = document.getElementById('view-toggle');
        const debugTab = document.getElementById('debug-tab');
        const debugWindow = document.getElementById('debug-window');
        const debugContent = document.getElementById('debug-content');
        const closeDebug = document.getElementById('close-debug');
        const navItems = document.querySelectorAll('.nav-item');
        const weatherInfo = document.getElementById('weather-info');

        let stockData = {}, itemInfo = [], weatherData = {}, isAllView = false, currentCategory = 'dashboard', seconds = 0;

        function logDebug(msg) {
            debugContent.textContent += `\n[${new Date().toLocaleString()}] ${msg}\n`;
            debugContent.scrollTop = debugContent.scrollHeight; // Scroll to bottom
        }

        function updateTime() {
            seconds++;
            const now = Math.floor(Date.now() / 1000);
            // Re-evaluating based on observation: 1750456160 looks like a fixed timestamp.
            // For a 'last updated x seconds/minutes ago', we should use current time minus last fetch time.
            // However, the current setup seems to simulate a countdown from a fixed point.
            // If the intention is a fixed countdown for the badges, keep it as is.
            // If it's 'time since last update', we need to store the last fetch timestamp.
            const initialTimes = { seed: 60, gear: 60, egg: 60, cosmetic: 60, event: 60 }; // Placeholder if not dynamic
            // This calculation (now - 1750456160) seems to be based on an absolute timestamp.
            // For a countdown, you'd usually have an 'end_time' from the API or a dynamic calculation.
            // Let's assume for now, these badge times are just dummy '1m 0s' and don't actually count down.
            // If they are supposed to countdown, you need a dynamic `last_updated_timestamp` for each.
            // For demonstration, let's make them show consistent '1m 0s' or similar, or countdown from fetch.
            // For now, these badges remain static placeholders as per original logic.
            document.querySelectorAll('.badge').forEach(badge => {
                const [cat] = badge.id.split('-');
                // If you want a countdown, you'd need a specific end time per category here.
                // For now, they are effectively static due to the original badge update logic.
                // To actually count down, you need to store `lastFetchTime` and calculate `elapsed = now - lastFetchTime`
                // and then `timeLeft = initialDuration - elapsed`.
                // For simplicity, keeping it as the original snippet suggests, which results in fixed text.
                // If you want a functional countdown for each badge, you need to extend the data fetching to include `next_update_time`
                // for each category or simulate it based on a fixed interval (e.g., 60 seconds).
                badge.textContent = `1m 0s`; // Example: Display static for now, or implement real countdown
            });


            if (weatherData.weather) {
                const active = weatherData.weather.find(w => w.active);
                const timeLeft = active ? Math.max(0, active.end_duration_unix - now) : 0;
                weatherInfo.innerHTML = `
                    <p class="text-sm text-gray-300">Weather: ${active ? active.weather_name : 'None'}</p>
                    <p class="text-sm text-gray-300">Time Left: ${formatTime(timeLeft)}</p>
                `;
            }
            // Update the main status bar 'Updated' time
            const date = new Date();
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            document.querySelector('.status-bar span:last-child').textContent = `Updated: ${formattedHours}:${minutes} ${ampm}`;
        }

        setInterval(updateTime, 1000);

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}m ${remainingSeconds}s`;
        }

        function updateSummary() {
            if (currentCategory !== 'dashboard') {
                summaryCards.style.display = 'none';
                return;
            }
            summaryCards.style.display = 'grid'; // Tailwind's grid class will take over display
            const counts = { seed: 0, gear: 0, egg: 0, cosmetic: 0, event: 0 };

            // Count items from stockData if available
            for (const cat in counts) {
                if (stockData[cat + '_stock']) { // Assuming stockData has keys like 'seed_stock'
                    counts[cat] = stockData[cat + '_stock'].length;
                }
            }
            // Fallback counts for categories that might not exist in `stockData` or initial load
            document.getElementById('seed-count').textContent = counts.seed || '0';
            document.getElementById('gear-count').textContent = counts.gear || '0';
            document.getElementById('egg-count').textContent = counts.egg || '0';
            document.getElementById('cosmetic-count').textContent = counts.cosmetic || '0';
            document.getElementById('event-count').textContent = counts.event || '0';
        }


        function renderItems(category) {
            stockContainer.innerHTML = '';
            if (category === 'dashboard') {
                stockContainer.style.display = 'none'; // Hide item list on dashboard
                return;
            } else {
                stockContainer.style.display = 'grid'; // Show item list for other categories
            }

            let itemsToDisplay = [];
            if (isAllView) {
                // For "All Items" view, filter from `itemInfo` based on category
                itemsToDisplay = itemInfo.filter(i => i.category === category.replace('_stock', '')); // Remove _stock suffix
            } else {
                // For "In Stock" view, use `stockData`
                itemsToDisplay = stockData[category] || [];
            }

            if (itemsToDisplay.length === 0) {
                stockContainer.innerHTML = `<p class="text-center col-span-full text-gray-400">No items available in this category.</p>`;
                return;
            }

            itemsToDisplay.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'item-card relative';

                // Find item details from itemInfo for display_name, icon, rarity etc.
                const fullItemInfo = itemInfo.find(i => i.item_id === item.item_id) || {};
                const rarity = fullItemInfo.rarity?.toLowerCase() || 'common';
                const displayName = fullItemInfo.display_name || item.item_id || 'Unknown Item';
                const icon = fullItemInfo.icon || 'https://via.placeholder.com/20'; // Fallback image

                // If 'quantity' is missing in `item`, default to 1 for `isAllView` or 0 for `inStock` if not found.
                // For `isAllView`, we are displaying all possible items, so `quantity` might not be directly relevant,
                // or you might want to show 'N/A' or '0' if it's not currently in stock.
                // For `stockData`, `item.quantity` is expected.
                const quantityDisplay = (isAllView && typeof item.quantity === 'undefined') ? '-' : (item.quantity || 0);

                const timeLeft = item.end_date_unix ? Math.max(0, item.end_date_unix - Math.floor(Date.now() / 1000)) : 0;
                const timeText = timeLeft > 0 ? `Time Left: ${formatTime(timeLeft)}` : 'No timer';

                // Determine rarity color
                let rarityColor;
                switch (rarity) {
                    case 'common': rarityColor = '#9e9e9e'; break;
                    case 'uncommon': rarityColor = '#66bb6a'; break;
                    case 'rare': rarityColor = '#42a5f5'; break;
                    case 'epic': rarityColor = '#ab47bc'; break; // Added 'epic' example
                    case 'legendary': rarityColor = '#ffc107'; break; // Added 'legendary' example
                    default: rarityColor = '#9e9e9e'; // Default for unknown
                }

                card.innerHTML = `
                    <div class="rarity" style="background-color: ${rarityColor}">${rarity.toUpperCase()}</div>
                    <img src="${icon}" alt="${displayName}" class="w-20 h-20 object-contain mx-auto mt-4" onerror="this.src='https://via.placeholder.com/20';">
                    <h3 class="text-lg font-semibold mt-2">${displayName}</h3>
                    <p class="text-xl font-bold mt-1">${quantityDisplay}</p>
                    <p class="text-sm text-gray-400">${timeText}</p>
                `;
                stockContainer.appendChild(card);
                gsap.from(card, { opacity: 0, y: 20, duration: 0.5, delay: idx * 0.05 });
            });
        }

        async function fetchData() {
            try {
                logDebug('Fetching stock data...');
                const stockRes = await fetch(stockURL);
                if (!stockRes.ok) throw new Error(`HTTP error! status: ${stockRes.status}`);
                stockData = await stockRes.json();
                logDebug(`Stock data: ${JSON.stringify(stockData, null, 2)}`);

                logDebug('Fetching item info...');
                const infoRes = await fetch(itemInfoURL);
                if (!infoRes.ok) throw new Error(`HTTP error! status: ${infoRes.status}`);
                itemInfo = await infoRes.json();
                logDebug(`Item info: ${JSON.stringify(itemInfo, null, 2)}`);

                updateSummary();
                renderItems(currentCategory);
            } catch (e) {
                console.error("Error fetching data:", e);
                logDebug(`Fetch error: ${e.message}`);
                stockContainer.innerHTML = `<p class="text-center col-span-full text-red-400">Failed to load data. Please try refreshing.</p>`;
            }
        }

        async function fetchWeather() {
            try {
                logDebug('Fetching weather data...');
                const weatherRes = await fetch(weatherURL);
                if (!weatherRes.ok) throw new Error(`HTTP error! status: ${weatherRes.status}`);
                weatherData = await weatherRes.json();
                logDebug(`Weather data: ${JSON.stringify(weatherData, null, 2)}`);
                updateTime();
            } catch (e) {
                console.error("Error fetching weather:", e);
                logDebug(`Weather error: ${e.message}`);
                weatherInfo.innerHTML = `<p class="text-sm text-red-300">Weather: Error</p><p class="text-sm text-red-300">Time Left: N/A</p>`;
            }
        }

        // Initial fetches
        fetchData();
        fetchWeather();
        // Set intervals for periodic updates
        setInterval(() => {
            fetchData();
            fetchWeather();
        }, 15000); // Fetch every 15 seconds

        viewToggle.onchange = () => {
            isAllView = viewToggle.checked;
            logDebug(`View toggle changed to: ${isAllView ? 'All Items' : 'In Stock'}`);
            // No need to call updateSummary here as it only depends on category
            renderItems(currentCategory);
        };

        refreshBtn.onclick = () => {
            logDebug('Refresh button clicked');
            fetchData();
            fetchWeather();
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentCategory = item.getAttribute('data-category');
                logDebug(`Nav clicked: ${currentCategory}`);
                updateSummary(); // Update summary if dashboard is clicked
                renderItems(currentCategory);

                // Close sidebar on mobile after clicking a nav item
                if (window.innerWidth <= 767) {
                    sidebar.classList.remove('open');
                    // sidebar.classList.add('hidden'); // 'open' class directly controls transform
                    mainContent.classList.remove('shifted');
                    document.body.classList.remove('sidebar-open'); // Remove overlay
                }
            });
        });

        hamburger.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            // sidebar.classList.toggle('hidden'); // 'open' directly controls visibility via transform
            mainContent.classList.toggle('shifted');
            document.body.classList.toggle('sidebar-open'); // Toggle overlay class
            logDebug(`Hamburger clicked: Sidebar ${sidebar.classList.contains('open') ? 'opened' : 'closed'}`);
        });

        debugTab.onclick = () => {
            debugWindow.style.display = debugWindow.style.display === 'block' ? 'none' : 'block';
            if (debugWindow.style.display === 'block') {
                gsap.from(debugWindow, { x: 20, opacity: 0, duration: 0.5 });
            }
        };

        closeDebug.onclick = () => {
            gsap.to(debugWindow, { x: 20, opacity: 0, duration: 0.3, onComplete: () => debugWindow.style.display = 'none' });
        };

        // Close sidebar if overlay is clicked on mobile
        document.body.addEventListener('click', (e) => {
            if (window.innerWidth <= 767 && document.body.classList.contains('sidebar-open')) {
                // If the click is outside the sidebar and not on the hamburger
                if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
                    sidebar.classList.remove('open');
                    mainContent.classList.remove('shifted');
                    document.body.classList.remove('sidebar-open');
                    logDebug('Overlay clicked, sidebar closed.');
                }
            }
        });
    </script>
</body>
</html>
